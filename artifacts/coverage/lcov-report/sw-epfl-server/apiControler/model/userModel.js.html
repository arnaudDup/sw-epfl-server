<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for sw-epfl-server/apiControler/model/userModel.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">all files</a> / <a href="index.html">sw-epfl-server/apiControler/model/</a> userModel.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">65.49% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>74/113</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">61.11% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>22/36</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">65.49% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>74/113</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span></td><td class="text"><pre class="prettyprint lang-js">// Récupération du Modèle
var unirest = require('unirest');
var util = require('util');
var setting = require('../../setting/error.js');
var databaseConfig = require('../../setting/database.js');
var globalConfig = require('../../setting/global.js');
var userManipulation = require ('../object/user.js')
var utils = require('../utils/Utils.js');
var Constant = require ('../utils/Constant.js')
&nbsp;
// database
var databasePostgres = require('../database/postgres.js');
var User = require('../database/SequelizeORM.js').User;
var Music = require('../database/SequelizeORM.js').Music;
var Setting = require('../database/SequelizeORM.js').Setting;
&nbsp;
//---------------------------------- DEFINE CONSTANT ------------------------------------
&nbsp;
var URL_FACEBOOK = "https://graph.facebook.com/";
var FIELDS_FACEBOOK = 'email,cover,birthday,first_name,last_name,name,picture';
&nbsp;
//---------------------------------- DEFINE CONSTANT ------------------------------------
&nbsp;
// Définition de l'objet controllerUtilisateur
function controllerUtilisateur(){
&nbsp;
  // private method, allow to create a specific user by the object given by facebook.
  var createUser = function(res,backgroundPict,callback){
&nbsp;
          // build the url to get the picture
          var urlPictureFacebook = "https://graph.facebook.com/"+res.body.id+"/picture?height=500&amp;width=500"; 
          utils.logInfo("createUser(), insertion or geetin a user");
          var UserAge = userManipulation.computeAge(res.body.birthday);
&nbsp;
&nbsp;
          // Insert the new user in the database .
          User.sync({force: false}).then(function () {
&nbsp;
                var createUser =  User.create({
                        idApiConnection : res.body.id, 
                        lastname : res.body.last_name,
                        firstname: res.body.first_name,
                        email : res.body.email,
                        age : UserAge,
                        profilePicture : urlPictureFacebook,
                        backgroundPicture : backgroundPict
&nbsp;
                // callback if the user srequest succeed.
                }).then(function(createUser) {
&nbsp;
                  utils.logInfo("createUser(), the request succeed");
&nbsp;
                  // We associate with the default value.
                  createUser.setSetting(Constant.GeneralModel.idDefaultSetting);
&nbsp;
   
                  getUser.getSetting().then(<span class="fstat-no" title="function not covered" >function(associatedTasks) {</span>
<span class="cstat-no" title="statement not covered" >                      userManipulation.changeSetting(getUser.dataValues,associatedTasks.dataValues)</span>
                      
                      // We kepp only the id of facebook.
<span class="cstat-no" title="statement not covered" >                      delete getUser.dataValues['id']</span>
<span class="cstat-no" title="statement not covered" >                      var response = userManipulation.transformResponseClient(getUser.dataValues);</span>
<span class="cstat-no" title="statement not covered" >                      callback(response,setting.htmlCode.succes_request);</span>
                  }).catch(<span class="fstat-no" title="function not covered" >function(error) {</span>
<span class="cstat-no" title="statement not covered" >                      utils.logError("This User does not have any SettingValue"+error)</span>
<span class="cstat-no" title="statement not covered" >                      callback(null,setting.htmlCode.unavailable_ressources);</span>
                  });
&nbsp;
&nbsp;
                // return a 500 code if the request is null.
                }).catch(function(error) {
                     utils.logInfo("createUser(), the request fail" +error);
                    callback(null,setting.htmlCode.unavailable_ressources);
                })
&nbsp;
           });
    }
&nbsp;
&nbsp;
  // private method, allow to get a specific user designed by api connection.
  var getUserByIdConnection = function(idApi,callback){
&nbsp;
      var urlPictureFacebook = "https://graph.facebook.com/"+idApi+"/picture?height=500&amp;width=500"; 
      utils.logInfo("getUserByIdConnection(), get the user"+ idApi);
      User.sync().then(function () {
        // select query.
         var getUser =  User.findOne({
              where: {
                idApiConnection: idApi
              }
            }).then(function(getUser) {
&nbsp;
                utils.logInfo("request succeed"+idApi)
                getUser.getSetting().then(function(associatedTasks) {
                    userManipulation.changeSetting(getUser.dataValues,associatedTasks.dataValues)
                    delete getUser.dataValues['id']
                    var response = userManipulation.transformResponseClient(getUser.dataValues);
                    callback(response,setting.htmlCode.succes_request);
                }).catch(<span class="fstat-no" title="function not covered" >function(error) {</span>
<span class="cstat-no" title="statement not covered" >                    utils.logError("This User does not have any SettingValue"+error)</span>
<span class="cstat-no" title="statement not covered" >                    callback(null,setting.htmlCode.unavailable_ressources);</span>
                });
&nbsp;
            }).catch(function(error) {
                utils.logError("error getting user : "+error)
                callback(null,setting.htmlCode.unavailable_ressources);
            });
        });
    }
&nbsp;
  // private method, allow to get a specific user designed by api connection.
  var getUserAroundByRadius = <span class="fstat-no" title="function not covered" >function(idApi,callback){</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      var urlPictureFacebook = "https://graph.facebook.com/"+idApi+"/picture?height=500&amp;width=500"; </span>
<span class="cstat-no" title="statement not covered" >      utils.logInfo("controllerUtilisateur(), insertion or geetin a user, adduser()");</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      User.sync().then(<span class="fstat-no" title="function not covered" >function () {</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >         var getUser =  User.findOne({</span>
              where: {
                idApiConnection: idApi
              }
&nbsp;
            }).then(<span class="fstat-no" title="function not covered" >function(getUser) {</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                utils.logError("request succeed"+idApi)</span>
<span class="cstat-no" title="statement not covered" >                delete getUser.dataValues['id']</span>
<span class="cstat-no" title="statement not covered" >                var user1 = userManipulation.transformResponseClient(getUser.dataValues);</span>
<span class="cstat-no" title="statement not covered" >                var testUser = [user1,user1]</span>
<span class="cstat-no" title="statement not covered" >                callback(testUser,setting.htmlCode.succes_request);</span>
&nbsp;
            }).catch(<span class="fstat-no" title="function not covered" >function(error) {</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                utils.logError("error getting user : "+idApi)</span>
<span class="cstat-no" title="statement not covered" >                callback(null,setting.htmlCode.unavailable_ressources);</span>
            });
        });
    }
&nbsp;
&nbsp;
    this.updateGetInformationUser = function (body,callback)
    {     
        utils.logDebug("adduser()"+JSON.stringify(buildRequestFacebook(body.id,body.accesToken)));
&nbsp;
        // GET the user description by doing a post on facebook API.
        unirest.get(buildRequestFacebook(body.id,body.accesToken)).end(function(res){
&nbsp;
          // We can't reach the facebook graph.
          if (res.error) {
           callback(null,setting.htmlCode.unavailable_ressources);
          }
          else {
                // make an JsonObject.
                res.body  = JSON.parse(res.body); 
                // build the url to get the picture
                var urlPictureFacebook = "https://graph.facebook.com/"+res.body.id+"/picture?height=500&amp;width=500"; 
&nbsp;
                utils.logInfo("updateGetInformationUser(), insertion or geetin a user, adduser()");
&nbsp;
                var backgroundPict
                <span class="missing-if-branch" title="else path not taken" >E</span>if (res.body.cover ==  undefined){
                  backgroundPict = "https://graph.facebook.com/"+121620614972695+"/picture?height=500&amp;width=500"
                }
                else{
<span class="cstat-no" title="statement not covered" >                  backgroundPict =  res.body.cover.source</span>
                }
&nbsp;
               // We synchronize with the databse in order to change the name and the 
               User.sync({}).then(function () {
&nbsp;
                     var CreateUser =  User.update({
                          email : res.body.email,
                          profilePicture : urlPictureFacebook,
                          backgroundPicture : backgroundPict
                      }, 
                      {
                      where: {
                                idApiConnection: res.body.id
                             }
                  // callback if the user srequest succeed.
                  }).then(function(CreateUser) {
                      utils.logInfo("updateGetInformationUser(), the request succeed");
&nbsp;
                      // We don't find any users with the id, we need to add the new user
                      // to the database.
                      <span class="missing-if-branch" title="else path not taken" >E</span>if(CreateUser[0] == 0){
                        utils.logInfo("creation d'un nouveau utilisateur");
                        createUser(res,backgroundPict,callback);
                      }
                      // We get the user in the database and send to the client. 
                      else{
<span class="cstat-no" title="statement not covered" >                          utils.logInfo("get the user freshly updated");</span>
<span class="cstat-no" title="statement not covered" >                          getUserByIdConnection(res.body.id,callback);</span>
                      }
&nbsp;
                  // if there is any error in computing value for user.
                  }).catch(<span class="fstat-no" title="function not covered" >function(error) {</span>
<span class="cstat-no" title="statement not covered" >                       utils.logInfo("updateGetInformationUser(), the request fail"+error);</span>
<span class="cstat-no" title="statement not covered" >                       callback(null,setting.htmlCode.unavailable_ressources);</span>
                  })
&nbsp;
              });
            }
&nbsp;
        })
    };
&nbsp;
  this.getUsersAround = <span class="fstat-no" title="function not covered" >function(UserObject,callback){</span>
<span class="cstat-no" title="statement not covered" >      utils.logInfo("getUsersAround()");</span>
<span class="cstat-no" title="statement not covered" >      utils.logInfo(UserObject);</span>
&nbsp;
      // We synchronize with the databse in order to change the name and the 
<span class="cstat-no" title="statement not covered" >       User.sync({force: false}).then(<span class="fstat-no" title="function not covered" >function () {</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            var updateUser =  User.update({</span>
                lattitude : UserObject.lattitude,
                longitude : UserObject.longitude,
              }, 
              {
              where: {
                        idApiConnection: UserObject.idApiConnection
                     }
          // callback if the user srequest succeed.
          }).then(<span class="fstat-no" title="function not covered" >function(updateUser) {</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >              if(updateUser[0] == 0){</span>
<span class="cstat-no" title="statement not covered" >                utils.logInfo("The User does not exist !");</span>
<span class="cstat-no" title="statement not covered" >                callback(null,setting.htmlCode.unavailable_ressources);</span>
              }
              // We get the user in the database and send to the client. 
              else{
<span class="cstat-no" title="statement not covered" >                  utils.logInfo("I'am update the user");</span>
<span class="cstat-no" title="statement not covered" >                  getUserAroundByRadius(UserObject.idApiConnection,callback);</span>
              }
          }).catch(<span class="fstat-no" title="function not covered" >function(error) {</span>
<span class="cstat-no" title="statement not covered" >               utils.logInfo("controllerUtilisateur(), the request fail");</span>
<span class="cstat-no" title="statement not covered" >                callback(null,setting.htmlCode.unavailable_ressources);</span>
          })
&nbsp;
      });
&nbsp;
&nbsp;
    }  
&nbsp;
    this.getUser = function(idApi,callback){
      utils.logInfo("controllerUtilisateur(), get user "+idApi+", getUser()");
      getUserByIdConnection(idApi,callback)
    }  
&nbsp;
    this.removeUser = function(idApi,callback){
&nbsp;
       User.sync().then(function () {
&nbsp;
           // delete the user.
           var deleteUser =  User.destroy({
                  where: {
                    idApiConnection: idApi
                  }
&nbsp;
          // callback if the user srequest succeed.
          }).then(function(deleteUser) {
                  utils.logInfo("controllerUtilisateur(), the request succeed");
                  callback(null,setting.htmlCode.succes_request);
&nbsp;
          // return a 500 code if the request is null.
          }).catch(<span class="fstat-no" title="function not covered" >function(error) {</span>
<span class="cstat-no" title="statement not covered" >               utils.logInfo("controllerUtilisateur(), the request fail"+error);</span>
<span class="cstat-no" title="statement not covered" >              callback(null,setting.htmlCode.unavailable_ressources);</span>
          })
&nbsp;
      });
    }    
&nbsp;
    
    this.updateUser = function (idApi,UserDto,callback){
&nbsp;
      // We synchronize with the databse in order to change the name and the 
       User.sync({force: false}).then(function () {
&nbsp;
            var updateUser =  User.update({
                lastname: UserDto.lastname,
                firstname : UserDto.firstname,
                description: UserDto.description,
              }, 
              {
              where: {
                        idApiConnection: idApi
                     }
          // callback if the user srequest succeed.
          }).then(function(updateUser) {
                  utils.logInfo("controllerUtilisateur(), the request succeed");
                  callback(null,setting.htmlCode.succes_request);
&nbsp;
          // return a 500 code if the request is null.
          }).catch(<span class="fstat-no" title="function not covered" >function(error) {</span>
<span class="cstat-no" title="statement not covered" >               utils.logInfo("controllerUtilisateur(), the request fail"+error);</span>
<span class="cstat-no" title="statement not covered" >              callback(null,setting.htmlCode.unavailable_ressources);</span>
          })
&nbsp;
      });
    } 
&nbsp;
    var buildRequestFacebook = function(id , accessToken){
        return URL_FACEBOOK + id +"?fields="+ FIELDS_FACEBOOK +"&amp;access_token="+ accessToken +"&amp;height=500&amp;width=500"; 
    }
}
&nbsp;
module.exports = new controllerUtilisateur();</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Nov 04 2016 23:05:00 GMT+0100 (CET)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
